<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>MemDB by rain1017</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">MemDB</h1>
      <h2 class="project-tagline">Distributed transactional in memory database</h2>
      <a href="https://github.com/rain1017/memdb" class="btn">View on GitHub</a>
      <a href="https://github.com/rain1017/memdb/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/rain1017/memdb/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h2>
<a id="why-memdb" class="anchor" href="#why-memdb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why memdb?</h2>

<ul>
<li><p><strong>Performance</strong> : In memory data access which is extremely fast.</p></li>
<li><p><strong>Scalable</strong> : System is horizontally scalable by adding more shards.</p></li>
<li><p><strong>Transaction</strong> : Full transaction support like traditional database, data consistency is guaranteed. 'row' based locking mechanism is used.</p></li>
<li><p><strong>Simple</strong> : It's just a 'mongodb' with transaction support.</p></li>
</ul>

<p><strong>Comparison with other databases</strong></p>

<table>
<thead>
<tr>
<th>Database</th>
<th>Performance</th>
<th>Horizontally Scalable</th>
<th>Transaction Support</th>
<th>Data Structure</th>
</tr>
</thead>
<tbody>
<tr>
<td>MySQL</td>
<td>Medium (Disk I/O)</td>
<td>No</td>
<td><strong>Yes (InnoDB)</strong></td>
<td>Row based</td>
</tr>
<tr>
<td>MongoDB</td>
<td>Medium (Disk I/O)</td>
<td><strong>Yes</strong></td>
<td>No  (except some basic atomic modifier)</td>
<td><strong>Object(BSON)</strong></td>
</tr>
<tr>
<td>Redis</td>
<td><strong>High (Memory)</strong></td>
<td><strong>Yes</strong></td>
<td>No  (.multi can do some 'transaction like' thing)</td>
<td>Very Elemental</td>
</tr>
<tr>
<td><strong>MemDB</strong></td>
<td><strong>High (Memory)</strong></td>
<td><strong>Yes</strong></td>
<td><strong>Yes</strong></td>
<td><strong>Object(JSON)</strong></td>
</tr>
</tbody>
</table>

<h2>
<a id="documents" class="anchor" href="#documents" aria-hidden="true"><span class="octicon octicon-link"></span></a>Documents</h2>

<h3>
<a id="the-wiki" class="anchor" href="#the-wiki" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://github.com/rain1017/memdb/wiki">The Wiki</a>
</h3>

<h2>
<a id="quick-start" class="anchor" href="#quick-start" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick Start</h2>

<h3>
<a id="install-dependencies" class="anchor" href="#install-dependencies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install Dependencies</h3>

<ul>
<li><p>Install <a href="https://nodejs.org/download/">Node.js &gt;=v0.10</a></p></li>
<li><p>Install <a href="http://redis.io/download">Redis</a></p></li>
<li><p>Install <a href="https://www.mongodb.org/downloads">MongoDB</a></p></li>
</ul>

<h3>
<a id="install-memdb" class="anchor" href="#install-memdb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install MemDB</h3>

<ul>
<li>Install memdb</li>
</ul>

<pre><code>sudo npm install -g memdb-server
</code></pre>

<h3>
<a id="configure-memdb" class="anchor" href="#configure-memdb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure MemDB</h3>

<p>Modify settings in <code>.memdb.js</code> on your need. Please read comments carefully.</p>

<h3>
<a id="start-memdb" class="anchor" href="#start-memdb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Start MemDB</h3>

<p>Use <code>memdbcluster</code> to control lifecycle of memdb server cluster</p>

<pre><code>memdbcluster [start | stop | status] [--conf=.memdb.js] [--shard=shardId]
</code></pre>

<h3>
<a id="play-with-memdb-shell" class="anchor" href="#play-with-memdb-shell" aria-hidden="true"><span class="octicon octicon-link"></span></a>Play with memdb shell</h3>

<div class="highlight highlight-js"><pre>$ memdb <span class="pl-k">-</span>h <span class="pl-c1">127.0</span>.<span class="pl-c1">0.1</span> <span class="pl-k">-</span>p <span class="pl-c1">31017</span> <span class="pl-c">// specify the shard's host and port to connect</span>
MemDB shell
connected to <span class="pl-c1">127.0</span>.<span class="pl-c1">0.1</span><span class="pl-k">:</span><span class="pl-c1">31017</span>
memdb<span class="pl-k">&gt;</span> db.insert(<span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>, {_id <span class="pl-k">:</span> <span class="pl-c1">1</span>, name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>rain<span class="pl-pds">'</span></span>}) <span class="pl-c">// insert a doc to 'player' collection</span>
<span class="pl-s"><span class="pl-pds">'</span>1<span class="pl-pds">'</span></span>
memdb<span class="pl-k">&gt;</span> db.<span class="pl-c1">find</span>(<span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>, <span class="pl-c1">1</span>)  <span class="pl-c">// find doc by id</span>
{ _id<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>1<span class="pl-pds">'</span></span>, name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>rain<span class="pl-pds">'</span></span> }
memdb<span class="pl-k">&gt;</span> db.commit() <span class="pl-c">// commit changes</span>
<span class="pl-c1">true</span>
memdb<span class="pl-k">&gt;</span> db.update(<span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>, <span class="pl-c1">1</span>, {$set <span class="pl-k">:</span> {name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>snow<span class="pl-pds">'</span></span>}}) <span class="pl-c">// update doc</span>
<span class="pl-c1">1</span>
memdb<span class="pl-k">&gt;</span> db.<span class="pl-c1">find</span>(<span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>, <span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>)
{ name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>snow<span class="pl-pds">'</span></span> }
memdb<span class="pl-k">&gt;</span> db.rollback() <span class="pl-c">// rollback changes</span>
<span class="pl-c1">true</span>
memdb<span class="pl-k">&gt;</span> db.<span class="pl-c1">find</span>(<span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>, <span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>)
{ name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>rain<span class="pl-pds">'</span></span> }
memdb<span class="pl-k">&gt;</span> db.remove(<span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>, <span class="pl-c1">1</span>) <span class="pl-c">// remove doc</span>
<span class="pl-c1">1</span>
memdb<span class="pl-k">&gt;</span> db.commit()
<span class="pl-c1">true</span>
memdb<span class="pl-k">&gt;</span> <span class="pl-k">^</span>D (to exit)</pre></div>

<h3>
<a id="nodejs-client-using-autoconnection" class="anchor" href="#nodejs-client-using-autoconnection" aria-hidden="true"><span class="octicon octicon-link"></span></a>Nodejs client using AutoConnection</h3>

<p>AutoConnection manages a pool of connections for each shard, execute transaction on specified shard, and auto commit on transaction complete or rollback on failure.</p>

<div class="highlight highlight-js"><pre><span class="pl-c">// To run the sample:</span>
<span class="pl-c">// npm install memdb-client</span>
<span class="pl-c">// run with node &gt;= 0.12 with --harmony option</span>
<span class="pl-c">// We assume you have started shard 's1' on localhost:31017, 's2' on localhost:31018.</span>

<span class="pl-k">var</span> memdb <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>memdb-client<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> P <span class="pl-k">=</span> memdb.Promise; <span class="pl-c">// just bluebird promise</span>

<span class="pl-k">var</span> main <span class="pl-k">=</span> P.coroutine(<span class="pl-k">function*</span>(){
    <span class="pl-c">// All database access should via this autoconn object, </span>
    <span class="pl-c">// you can preserve autoconn object in a global module that can be accessed anywhere</span>
    <span class="pl-k">var</span> autoconn <span class="pl-k">=</span> <span class="pl-k">yield</span> memdb.autoConnect({
        shards <span class="pl-k">:</span> { <span class="pl-c">// Specify all shards here</span>
            s1 <span class="pl-k">:</span> {host <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>, port <span class="pl-k">:</span> <span class="pl-c1">31017</span>},
            s2 <span class="pl-k">:</span> {host <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>, port <span class="pl-k">:</span> <span class="pl-c1">31018</span>},
        }
    });

    <span class="pl-k">var</span> doc <span class="pl-k">=</span> {_id <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>1<span class="pl-pds">'</span></span>, name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>rain<span class="pl-pds">'</span></span>, level <span class="pl-k">:</span> <span class="pl-c1">1</span>};

    <span class="pl-c">// Get player collection object</span>
    <span class="pl-k">var</span> Player <span class="pl-k">=</span> autoconn.collection(<span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>);

    <span class="pl-c">// Make a transaction in shard s1</span>
    <span class="pl-k">yield</span> autoconn.transaction(P.coroutine(<span class="pl-k">function*</span>(){
        <span class="pl-c">// Upsert a doc (update if exist, insert if not exist)</span>
        <span class="pl-k">yield</span> Player.update(doc._id, doc, {upsert <span class="pl-k">:</span> <span class="pl-c1">true</span>});
        <span class="pl-c">// Find the doc</span>
        <span class="pl-k">var</span> ret <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.<span class="pl-c1">find</span>(doc._id);
        <span class="pl-en">console</span><span class="pl-c1">.log</span>(ret); <span class="pl-c">// {_id : '1', name : 'rain', level : 1}</span>
    }), <span class="pl-s"><span class="pl-pds">'</span>s1<span class="pl-pds">'</span></span>); <span class="pl-c">// Auto commit after transaction</span>

    <span class="pl-k">try</span>{
        <span class="pl-c">// Make another transaction in shard s1</span>
        <span class="pl-k">yield</span> autoconn.transaction(P.coroutine(<span class="pl-k">function*</span>(){
            <span class="pl-c">// Update doc with $set modifier</span>
            <span class="pl-k">yield</span> Player.update(doc._id, {$set <span class="pl-k">:</span> {level <span class="pl-k">:</span> <span class="pl-c1">2</span>}});
            <span class="pl-c">// Find the changed doc with specified field</span>
            <span class="pl-k">var</span> ret <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.<span class="pl-c1">find</span>(doc._id, <span class="pl-s"><span class="pl-pds">'</span>level<span class="pl-pds">'</span></span>);
            <span class="pl-en">console</span><span class="pl-c1">.log</span>(ret); <span class="pl-c">// {level : 2}</span>
            <span class="pl-c">// Exception here!</span>
            <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">Error</span>(<span class="pl-s"><span class="pl-pds">'</span>Oops!<span class="pl-pds">'</span></span>);
        }), <span class="pl-s"><span class="pl-pds">'</span>s1<span class="pl-pds">'</span></span>);
    }
    <span class="pl-k">catch</span>(err){ <span class="pl-c">// Catch the exception</span>
        <span class="pl-c">// Change is rolled back</span>
        <span class="pl-k">yield</span> autoconn.transaction(P.coroutine(<span class="pl-k">function*</span>(){
            <span class="pl-k">var</span> ret <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.<span class="pl-c1">find</span>(doc._id, <span class="pl-s"><span class="pl-pds">'</span>level<span class="pl-pds">'</span></span>);
            <span class="pl-en">console</span><span class="pl-c1">.log</span>(ret); <span class="pl-c">// {level : 1}</span>
        }), <span class="pl-s"><span class="pl-pds">'</span>s1<span class="pl-pds">'</span></span>);
    }

    <span class="pl-c">// Make transcation in another shard</span>
    <span class="pl-c">// Since we just accessed this doc in s1, the doc will 'fly' from shard s1 to s2</span>
    <span class="pl-c">// In real production you should avoid these kind of data 'fly' by routing transaction to proper shard</span>
    <span class="pl-k">yield</span> autoconn.transaction(P.coroutine(<span class="pl-k">function*</span>(){
        <span class="pl-k">yield</span> Player.remove(doc._id);
    }), <span class="pl-s"><span class="pl-pds">'</span>s2<span class="pl-pds">'</span></span>);

    <span class="pl-c">// Close all connections</span>
    <span class="pl-k">yield</span> autoconn.<span class="pl-c1">close</span>();
});

<span class="pl-k">if</span> (<span class="pl-c1">require</span>.main <span class="pl-k">===</span> <span class="pl-c1">module</span>) {
    main().finally(<span class="pl-c1">process</span>.exit);
}</pre></div>

<h3>
<a id="nodejs-client-using-mdbgoose" class="anchor" href="#nodejs-client-using-mdbgoose" aria-hidden="true"><span class="octicon octicon-link"></span></a>Nodejs client using MdbGoose</h3>

<p>Mdbgoose is the 'mongoose' for memdb</p>

<div class="highlight highlight-js"><pre><span class="pl-c">// To run the sample:</span>
<span class="pl-c">// npm install memdb-client</span>
<span class="pl-c">// run with node &gt;= 0.12 with --harmony option</span>
<span class="pl-c">// We assume you have started shard 's1' on localhost:31017</span>

<span class="pl-k">var</span> memdb <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>memdb-client<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> P <span class="pl-k">=</span> memdb.Promise;
<span class="pl-k">var</span> mdbgoose <span class="pl-k">=</span> memdb.goose;

<span class="pl-c">// Define player schema</span>
<span class="pl-k">var</span> playerSchema <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">mdbgoose.Schema</span>({
    _id <span class="pl-k">:</span> <span class="pl-c1">String</span>,
    name <span class="pl-k">:</span> <span class="pl-c1">String</span>,
    areaId <span class="pl-k">:</span> <span class="pl-c1">Number</span>,
    deviceType <span class="pl-k">:</span> <span class="pl-c1">Number</span>,
    deviceId <span class="pl-k">:</span> <span class="pl-c1">String</span>,
    items <span class="pl-k">:</span> [mdbgoose.SchemaTypes.Mixed],
}, {collection <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>});
<span class="pl-c">// Define player model</span>
<span class="pl-k">var</span> Player <span class="pl-k">=</span> mdbgoose.model(<span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>, playerSchema);

<span class="pl-k">var</span> main <span class="pl-k">=</span> P.coroutine(<span class="pl-k">function*</span>(){
    <span class="pl-c">// Connect to memdb</span>
    <span class="pl-k">yield</span> mdbgoose.connectAsync({
        shards <span class="pl-k">:</span> { <span class="pl-c">// specify all shards here</span>
            s1 <span class="pl-k">:</span> {host <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>, port<span class="pl-k">:</span> <span class="pl-c1">31017</span>},
        }
    });

    <span class="pl-c">// Make a transaction in s1</span>
    <span class="pl-k">yield</span> mdbgoose.transactionAsync(P.coroutine(<span class="pl-k">function*</span>(){

        <span class="pl-k">var</span> player <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Player</span>({
            _id <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>p1<span class="pl-pds">'</span></span>,
            name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>rain<span class="pl-pds">'</span></span>,
            areaId <span class="pl-k">:</span> <span class="pl-c1">1</span>,
            deviceType <span class="pl-k">:</span> <span class="pl-c1">1</span>,
            deviceId <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>id1<span class="pl-pds">'</span></span>,
            items <span class="pl-k">:</span> [],
        });

        <span class="pl-c">// insert a player</span>
        <span class="pl-k">yield</span> player.saveAsync();

        <span class="pl-c">// find player by id</span>
        <span class="pl-k">var</span> doc <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.findAsync(<span class="pl-s"><span class="pl-pds">'</span>p1<span class="pl-pds">'</span></span>);
        <span class="pl-en">console</span><span class="pl-c1">.log</span>(<span class="pl-s"><span class="pl-pds">'</span>%j<span class="pl-pds">'</span></span>, doc);

        <span class="pl-c">// find player by areaId, return array of players</span>
        <span class="pl-c">// (index should be configured in .memdb.js)</span>
        <span class="pl-k">var</span> docs <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.findAsync({areaId <span class="pl-k">:</span> <span class="pl-c1">1</span>});
        <span class="pl-en">console</span><span class="pl-c1">.log</span>(<span class="pl-s"><span class="pl-pds">'</span>%j<span class="pl-pds">'</span></span>, docs);

        <span class="pl-c">// find player by deviceType and deviceId</span>
        <span class="pl-c">// (index should be configured in .memdb.js)</span>
        player <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.findOneAsync({deviceType <span class="pl-k">:</span> <span class="pl-c1">1</span>, deviceId <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>id1<span class="pl-pds">'</span></span>});

        <span class="pl-c">// update player</span>
        player.areaId <span class="pl-k">=</span> <span class="pl-c1">2</span>;
        <span class="pl-k">yield</span> player.saveAsync();

        <span class="pl-c">// remove the player</span>
        <span class="pl-k">yield</span> player.removeAsync();

    }), <span class="pl-s"><span class="pl-pds">'</span>s1<span class="pl-pds">'</span></span>);
});

<span class="pl-k">if</span> (<span class="pl-c1">require</span>.main <span class="pl-k">===</span> <span class="pl-c1">module</span>) {
    main().finally(<span class="pl-c1">process</span>.exit);
}</pre></div>

<h2>
<a id="quick-pomelo" class="anchor" href="#quick-pomelo" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick-pomelo</h2>

<p><strong><a href="http://quickpomelo.com">quick-pomelo</a></strong> is a rapid and robust game server framework based on memdb</p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>MemDB - distributed transactional in memory database</p>

<p>Copyright (C) rain1017</p>

<p>This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.</p>

<p>This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.</p>

<p>You should have received a copy of the GNU General Public License
along with this program.  If not, see <a href="http://www.gnu.org/licenses/">http://www.gnu.org/licenses/</a>.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/rain1017/memdb">MemDB</a> is maintained by <a href="https://github.com/rain1017">rain1017</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-65397800-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>

