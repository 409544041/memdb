<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>MemDB by memdb</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">MemDB</h1>
      <h2 class="project-tagline">The world first distributed ACID transactional &#39;MongoDB&#39;</h2>
      <a href="https://github.com/memdb/memdb" class="btn">View on GitHub</a>
      <a href="https://github.com/memdb/memdb/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/memdb/memdb/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <ul>
<li><p><strong>Fast and Scalable</strong> : Fast in memory data access, and the capacity is horizontally scalable by adding more shards.</p></li>
<li><p><strong>ACID Transaction</strong> : Full <a href="https://en.wikipedia.org/wiki/ACID">ACID</a> transaction support on distributed environment.</p></li>
<li><p><strong>MongoDB Compatible</strong> : It's just a 'MongoDB' with transaction support, built-in 'Mongoose' support. </p></li>
</ul>

<p><img src="https://github.com/memdb/memdb/wiki/images/memdbshell.gif" alt="memdbshell.gif"></p>

<h2>
<a id="the-wiki" class="anchor" href="#the-wiki" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://github.com/memdb/memdb/wiki">The Wiki</a>
</h2>

<h2>
<a id="quick-start" class="anchor" href="#quick-start" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick Start</h2>

<h3>
<a id="install-dependencies" class="anchor" href="#install-dependencies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install Dependencies</h3>

<ul>
<li><p>Install <a href="https://nodejs.org/download/">Node.js</a></p></li>
<li><p>Install <a href="http://redis.io/download">Redis</a></p></li>
<li><p>Install <a href="https://www.mongodb.org/downloads">MongoDB</a></p></li>
</ul>

<h3>
<a id="install-memdb" class="anchor" href="#install-memdb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install MemDB</h3>

<ul>
<li>Install memdb</li>
</ul>

<pre><code>sudo npm install -g memdb-server
</code></pre>

<h3>
<a id="configure-memdb" class="anchor" href="#configure-memdb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure MemDB</h3>

<p>Copy default config file <code>node_modules/memdb-server/memdb.conf.js</code> to <code>~/.memdb/</code> (mkdir if not exist), and modify it on your need. 
Please read comments carefully.</p>

<h3>
<a id="start-memdb" class="anchor" href="#start-memdb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Start MemDB</h3>

<p>Use <code>memdbcluster</code> to control lifecycle of memdb server cluster</p>

<pre><code>memdbcluster [start | stop | status] [--conf=memdb.conf.js] [--shard=shardId]
</code></pre>

<h3>
<a id="play-with-memdb-shell" class="anchor" href="#play-with-memdb-shell" aria-hidden="true"><span class="octicon octicon-link"></span></a>Play with memdb shell</h3>

<p>See the top GIF, note how ACID transaction works.</p>

<h3>
<a id="nodejs-client-with-autoconnection" class="anchor" href="#nodejs-client-with-autoconnection" aria-hidden="true"><span class="octicon octicon-link"></span></a>Nodejs Client with AutoConnection</h3>

<div class="highlight highlight-js"><pre><span class="pl-k">var</span> memdb <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>memdb-client<span class="pl-pds">'</span></span>);
<span class="pl-c">// just bluebird promise</span>
<span class="pl-k">var</span> P <span class="pl-k">=</span> memdb.Promise;

<span class="pl-k">var</span> main <span class="pl-k">=</span> P.coroutine(<span class="pl-k">function*</span>(){
    <span class="pl-c">// All database access should via this autoconn object, you can preserve autoconn object in a global module that can be accessed anywhere</span>
    <span class="pl-k">var</span> autoconn <span class="pl-k">=</span> <span class="pl-k">yield</span> memdb.autoConnect({
        shards <span class="pl-k">:</span> { <span class="pl-c">// Specify all shards here</span>
            s1 <span class="pl-k">:</span> {host <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>, port <span class="pl-k">:</span> <span class="pl-c1">31017</span>},
            s2 <span class="pl-k">:</span> {host <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>, port <span class="pl-k">:</span> <span class="pl-c1">31018</span>},
        }
    });

    <span class="pl-k">var</span> doc <span class="pl-k">=</span> {_id <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>1<span class="pl-pds">'</span></span>, name <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>rain<span class="pl-pds">'</span></span>, level <span class="pl-k">:</span> <span class="pl-c1">1</span>};

    <span class="pl-c">// Get player collection object</span>
    <span class="pl-k">var</span> Player <span class="pl-k">=</span> autoconn.collection(<span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>);

    <span class="pl-c">// Make a transaction in shard s1</span>
    <span class="pl-k">yield</span> autoconn.transaction(P.coroutine(<span class="pl-k">function*</span>(){
        <span class="pl-c">// Upsert a doc (update if exist, insert if not exist)</span>
        <span class="pl-k">yield</span> Player.update(doc._id, doc, {upsert <span class="pl-k">:</span> <span class="pl-c1">true</span>});
        <span class="pl-c">// Find the doc</span>
        <span class="pl-k">var</span> ret <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.<span class="pl-c1">find</span>(doc._id);
        <span class="pl-en">console</span><span class="pl-c1">.log</span>(ret); <span class="pl-c">// {_id : '1', name : 'rain', level : 1}</span>
    }), <span class="pl-s"><span class="pl-pds">'</span>s1<span class="pl-pds">'</span></span>); <span class="pl-c">// Auto commit after transaction</span>

    <span class="pl-k">try</span>{
        <span class="pl-c">// Make another transaction in shard s1</span>
        <span class="pl-k">yield</span> autoconn.transaction(P.coroutine(<span class="pl-k">function*</span>(){
            <span class="pl-c">// Update doc with $set modifier</span>
            <span class="pl-k">yield</span> Player.update(doc._id, {$set <span class="pl-k">:</span> {level <span class="pl-k">:</span> <span class="pl-c1">2</span>}});
            <span class="pl-c">// Find the changed doc with specified field</span>
            <span class="pl-k">var</span> ret <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.<span class="pl-c1">find</span>(doc._id, <span class="pl-s"><span class="pl-pds">'</span>level<span class="pl-pds">'</span></span>);
            <span class="pl-en">console</span><span class="pl-c1">.log</span>(ret); <span class="pl-c">// {level : 2}</span>
            <span class="pl-c">// Exception here!</span>
            <span class="pl-k">throw</span> <span class="pl-k">new</span> <span class="pl-en">Error</span>(<span class="pl-s"><span class="pl-pds">'</span>Oops!<span class="pl-pds">'</span></span>);
        }), <span class="pl-s"><span class="pl-pds">'</span>s1<span class="pl-pds">'</span></span>);
    }
    <span class="pl-k">catch</span>(err){ <span class="pl-c">// Catch the exception</span>
        <span class="pl-c">// Change is rolled back</span>
        <span class="pl-k">yield</span> autoconn.transaction(P.coroutine(<span class="pl-k">function*</span>(){
            <span class="pl-k">var</span> ret <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.<span class="pl-c1">find</span>(doc._id, <span class="pl-s"><span class="pl-pds">'</span>level<span class="pl-pds">'</span></span>);
            <span class="pl-en">console</span><span class="pl-c1">.log</span>(ret); <span class="pl-c">// {level : 1}</span>
        }), <span class="pl-s"><span class="pl-pds">'</span>s1<span class="pl-pds">'</span></span>);
    }

    <span class="pl-c">// Make transcation in another shard</span>
    <span class="pl-k">yield</span> autoconn.transaction(P.coroutine(<span class="pl-k">function*</span>(){
        <span class="pl-k">yield</span> Player.remove(doc._id);
    }), <span class="pl-s"><span class="pl-pds">'</span>s2<span class="pl-pds">'</span></span>);

    <span class="pl-c">// Close all connections</span>
    <span class="pl-k">yield</span> autoconn.<span class="pl-c1">close</span>();
});

<span class="pl-k">if</span> (<span class="pl-c1">require</span>.main <span class="pl-k">===</span> <span class="pl-c1">module</span>) {
    main().finally(<span class="pl-c1">process</span>.exit);
}</pre></div>

<p>To run the sample above</p>

<ul>
<li>Make sure you have started shard 's1' on localhost:31017, 's2' on localhost:31018.</li>
<li>Install npm dependencies</li>
</ul>

<pre><code>npm install memdb-client
</code></pre>

<ul>
<li>run with node &gt;= 0.12 with --harmony option</li>
</ul>

<pre><code>node --harmony sample.js
</code></pre>

<h3>
<a id="mdbgoose" class="anchor" href="#mdbgoose" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mdbgoose</h3>

<p>Mdbgoose is a modified <a href="http://mongoosejs.com">Mongoose</a> version that work for memdb</p>

<div class="highlight highlight-js"><pre><span class="pl-k">var</span> memdb <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>memdb-client<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> P <span class="pl-k">=</span> memdb.Promise;
<span class="pl-k">var</span> mdbgoose <span class="pl-k">=</span> memdb.goose;

<span class="pl-c">// Define player schema</span>
<span class="pl-k">var</span> playerSchema <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">mdbgoose.Schema</span>({
    _id <span class="pl-k">:</span> <span class="pl-c1">String</span>,
    name <span class="pl-k">:</span> <span class="pl-c1">String</span>,
    areaId <span class="pl-k">:</span> <span class="pl-c1">Number</span>,
    deviceType <span class="pl-k">:</span> <span class="pl-c1">Number</span>,
    deviceId <span class="pl-k">:</span> <span class="pl-c1">String</span>,
    items <span class="pl-k">:</span> [mdbgoose.SchemaTypes.Mixed],
}, {collection <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>});
<span class="pl-c">// Define player model</span>
<span class="pl-k">var</span> Player <span class="pl-k">=</span> mdbgoose.model(<span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>, playerSchema);

<span class="pl-k">var</span> main <span class="pl-k">=</span> P.coroutine(<span class="pl-k">function*</span>(){
    <span class="pl-c">// Connect to memdb</span>
    <span class="pl-k">yield</span> mdbgoose.connectAsync({
        shards <span class="pl-k">:</span> { <span class="pl-c">// specify all shards here</span>
            s1 <span class="pl-k">:</span> {host <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>, port<span class="pl-k">:</span> <span class="pl-c1">31017</span>},
            s2 <span class="pl-k">:</span> {host <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>, port<span class="pl-k">:</span> <span class="pl-c1">31018</span>},
        }
    });

    <span class="pl-c">// Make a transaction in s1</span>
    <span class="pl-k">yield</span> mdbgoose.transactionAsync(P.coroutine(<span class="pl-k">function*</span>(){

        <span class="pl-k">var</span> player <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Player</span>({
            _id <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>p1<span class="pl-pds">'</span></span>,
            name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>rain<span class="pl-pds">'</span></span>,
            areaId <span class="pl-k">:</span> <span class="pl-c1">1</span>,
            deviceType <span class="pl-k">:</span> <span class="pl-c1">1</span>,
            deviceId <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>id1<span class="pl-pds">'</span></span>,
            items <span class="pl-k">:</span> [],
        });

        <span class="pl-c">// insert a player</span>
        <span class="pl-k">yield</span> player.saveAsync();

        <span class="pl-c">// find player by id</span>
        <span class="pl-k">var</span> doc <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.findByIdAsync(<span class="pl-s"><span class="pl-pds">'</span>p1<span class="pl-pds">'</span></span>);
        <span class="pl-en">console</span><span class="pl-c1">.log</span>(<span class="pl-s"><span class="pl-pds">'</span>%j<span class="pl-pds">'</span></span>, doc);

        <span class="pl-c">// find player by areaId, return array of players</span>
        <span class="pl-k">var</span> docs <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.findAsync({areaId <span class="pl-k">:</span> <span class="pl-c1">1</span>});
        <span class="pl-en">console</span><span class="pl-c1">.log</span>(<span class="pl-s"><span class="pl-pds">'</span>%j<span class="pl-pds">'</span></span>, docs);

        <span class="pl-c">// find player by deviceType and deviceId</span>
        player <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.findOneAsync({deviceType <span class="pl-k">:</span> <span class="pl-c1">1</span>, deviceId <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>id1<span class="pl-pds">'</span></span>});

        <span class="pl-c">// update player</span>
        player.areaId <span class="pl-k">=</span> <span class="pl-c1">2</span>;
        <span class="pl-k">yield</span> player.saveAsync();

        <span class="pl-c">// remove the player</span>
        <span class="pl-k">yield</span> player.removeAsync();

    }), <span class="pl-s"><span class="pl-pds">'</span>s1<span class="pl-pds">'</span></span>);
});

<span class="pl-k">if</span> (<span class="pl-c1">require</span>.main <span class="pl-k">===</span> <span class="pl-c1">module</span>) {
    main().finally(<span class="pl-c1">process</span>.exit);
}</pre></div>

<p>To run the sample above:</p>

<ul>
<li>Add the following index config in memdb.conf.js</li>
</ul>

<pre><code>collections : {
    player : {
        indexes : [
            {
                keys : ['areaId'],
            },
            {
                keys : ['deviceType', 'deviceId'],
                unique : true,
            },
        ]
    }
}
</code></pre>

<ul>
<li>Restart memdb cluster</li>
</ul>

<pre><code>memdbcluster stop
memdbcluster drop // drop existing data if database is not empty
memdbcluster start
</code></pre>

<ul>
<li>Make sure you have started shard 's1' on localhost:31017</li>
<li>Install npm dependencies</li>
</ul>

<pre><code>npm install memdb-client
</code></pre>

<ul>
<li>Run with node &gt;= 0.12 with --harmony option</li>
</ul>

<pre><code>node --harmony sample.js
</code></pre>

<h3>
<a id="tips" class="anchor" href="#tips" aria-hidden="true"><span class="octicon octicon-link"></span></a>Tips</h3>

<ul>
<li>Data is not bind to specified shard, you can access any data from any shard.</li>
<li>All operations inside a single transaction must be executed on one single shard.</li>
<li>Access the same data from the same shard if possible, which will maximize performance.</li>
</ul>

<p><strong>Please read <a href="https://github.com/memdb/memdb/wiki">The Wiki</a> for further reference</strong></p>

<h2>
<a id="contact-us" class="anchor" href="#contact-us" aria-hidden="true"><span class="octicon octicon-link"></span></a>Contact Us</h2>

<ul>
<li><a href="https://github.com/memdb/memdb/issues">Github Issue</a></li>
<li>Mailing list: <a href="https://groups.google.com/forum/#!forum/memdbd">memdbd@googlegroups.com</a>
</li>
<li>Email: <a href="mailto:memdbd@gmail.com">memdbd@gmail.com</a>
</li>
</ul>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>Copyright 2015 The MemDB Authors.</p>

<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied. See the License for the specific language governing
permissions and limitations under the License. See the AUTHORS file
for names of contributors.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/memdb/memdb">MemDB</a> is maintained by <a href="https://github.com/memdb">memdb</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

            <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-65397800-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
