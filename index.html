<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>MemDB by rain1017</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-dark.css">
    <script src="javascripts/scale.fix.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>MemDB</h1>
        <p>Distributed Transactional In-Memory Database (全球首个支持分布式事务的MongoDB)</p>
        <p class="view"><a href="https://github.com/rain1017/memdb">View the Project on GitHub <small>rain1017/memdb</small></a></p>
        <ul>
          <li><a href="https://github.com/rain1017/memdb/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/rain1017/memdb/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/rain1017/memdb">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h3>
<a id="performance-and-scalable" class="anchor" href="#performance-and-scalable" aria-hidden="true"><span class="octicon octicon-link"></span></a>Performance and Scalable</h3>

<ul>
<li>Fast in memory data access, up to 25,000 ops (single doc read/write) per shard (each shard take one CPU core).</li>
<li>System capacity is horizontally scalable, performance grows linearly by adding more shards.</li>
<li>No single point bottleneck, all part of system is scalable, unlimited capability potential.</li>
</ul>

<h3>
<a id="true-distributed-acid-transaction" class="anchor" href="#true-distributed-acid-transaction" aria-hidden="true"><span class="octicon octicon-link"></span></a>True Distributed ACID Transaction</h3>

<ul>
<li>True <a href="https://en.wikipedia.org/wiki/ACID">ACID</a>(Stands for Atomicity, Consistency, Isolation, Durability) transaction support on distributed environment.</li>
<li>MemDB brings ACID transaction support for MongoDB, on distributed environment! You can get full transaction support of traditional SQL database (like MySQL), while not losing the scalability of NoSQL database (like MongoDB).</li>
</ul>

<h3>
<a id="mongodb-and-mongoose-compatible" class="anchor" href="#mongodb-and-mongoose-compatible" aria-hidden="true"><span class="octicon octicon-link"></span></a>MongoDB and Mongoose Compatible</h3>

<ul>
<li>It's just a 'MongoDB' with a cache layer which support distributed transaction.</li>
<li>Directly use of MongoDB's query API.</li>
<li>Built-in Mongoose support, easy to port existing Mongoose project to MemDB.</li>
</ul>

<h3>
<a id="high-availability" class="anchor" href="#high-availability" aria-hidden="true"><span class="octicon octicon-link"></span></a>High Availability</h3>

<ul>
<li>Each shard is backed by one or more slaves, no single point of failure.</li>
</ul>

<h2>
<a id="links" class="anchor" href="#links" aria-hidden="true"><span class="octicon octicon-link"></span></a>Links</h2>

<ul>
<li>Home Page: <a href="http://memdb.org">http://memdb.org</a>
</li>
<li>Github: <a href="https://github.com/rain1017/memdb">https://github.com/rain1017/memdb</a>
</li>
<li>Wiki : <a href="https://github.com/rain1017/memdb/wiki">https://github.com/rain1017/memdb/wiki</a>
</li>
<li>Email: <a href="mailto:rain1017@gmail.com">rain1017@gmail.com</a>
</li>
<li>QQ: 9040044</li>
</ul>

<h2>
<a id="quick-start" class="anchor" href="#quick-start" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick Start</h2>

<h3>
<a id="install-dependencies" class="anchor" href="#install-dependencies" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install Dependencies</h3>

<ul>
<li>Install <a href="https://nodejs.org/download/">Node.js</a>
</li>
<li>Install <a href="http://redis.io/download">Redis</a>
</li>
<li>Install <a href="https://www.mongodb.org/downloads">MongoDB</a>
</li>
</ul>

<p>Make sure Redis and MongoDB has started</p>

<h3>
<a id="install-memdb" class="anchor" href="#install-memdb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install MemDB</h3>

<ul>
<li>MemDB should be installed globally</li>
</ul>

<pre><code>sudo npm install -g memdb-server
</code></pre>

<h3>
<a id="configure-memdb" class="anchor" href="#configure-memdb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configure MemDB</h3>

<p>Copy default config file from <code>node_modules/memdb-server/memdb.conf.js</code> to <code>~/.memdb/</code> (mkdir if not exist), and modify it on your need. 
Please read comments carefully.</p>

<h3>
<a id="start-memdb" class="anchor" href="#start-memdb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Start MemDB</h3>

<p>Use <code>memdbcluster</code> to control lifecycle of memdb server cluster</p>

<pre><code>memdbcluster [start | stop | status] [--conf=memdb.conf.js] [--shard=shardId]
</code></pre>

<h3>
<a id="play-with-memdb-shell" class="anchor" href="#play-with-memdb-shell" aria-hidden="true"><span class="octicon octicon-link"></span></a>Play with memdb shell</h3>

<p>See the video bellow, note how ACID transaction work cross multiple shards.
<img src="https://github.com/rain1017/memdb/wiki/images/memdbshell.gif" alt="memdbshell.gif"></p>

<h3>
<a id="mdbgoose" class="anchor" href="#mdbgoose" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mdbgoose</h3>

<p>Mdbgoose is a modified <strong><a href="http://mongoosejs.com">Mongoose</a></strong> version that work for memdb</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> memdb <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>memdb-client<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> P <span class="pl-k">=</span> memdb.Promise;
<span class="pl-k">var</span> mdbgoose <span class="pl-k">=</span> memdb.goose;

<span class="pl-c">// Define player schema</span>
<span class="pl-k">var</span> playerSchema <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">mdbgoose.Schema</span>({
    _id <span class="pl-k">:</span> <span class="pl-c1">String</span>,
    name <span class="pl-k">:</span> <span class="pl-c1">String</span>,
    areaId <span class="pl-k">:</span> <span class="pl-c1">Number</span>,
    deviceType <span class="pl-k">:</span> <span class="pl-c1">Number</span>,
    deviceId <span class="pl-k">:</span> <span class="pl-c1">String</span>,
    items <span class="pl-k">:</span> [mdbgoose.SchemaTypes.Mixed],
}, {collection <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>});
<span class="pl-c">// Define player model</span>
<span class="pl-k">var</span> Player <span class="pl-k">=</span> mdbgoose.model(<span class="pl-s"><span class="pl-pds">'</span>player<span class="pl-pds">'</span></span>, playerSchema);

<span class="pl-k">var</span> main <span class="pl-k">=</span> P.coroutine(<span class="pl-k">function*</span>(){
    <span class="pl-c">// Connect to memdb</span>
    <span class="pl-k">yield</span> mdbgoose.connectAsync({
        shards <span class="pl-k">:</span> { <span class="pl-c">// specify all shards here</span>
            s1 <span class="pl-k">:</span> {host <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>, port<span class="pl-k">:</span> <span class="pl-c1">31017</span>},
            s2 <span class="pl-k">:</span> {host <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>, port<span class="pl-k">:</span> <span class="pl-c1">31018</span>},
        }
    });

    <span class="pl-c">// Make a transaction in s1</span>
    <span class="pl-k">yield</span> mdbgoose.transactionAsync(P.coroutine(<span class="pl-k">function*</span>(){

        <span class="pl-k">var</span> player <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Player</span>({
            _id <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>p1<span class="pl-pds">'</span></span>,
            name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>rain<span class="pl-pds">'</span></span>,
            areaId <span class="pl-k">:</span> <span class="pl-c1">1</span>,
            deviceType <span class="pl-k">:</span> <span class="pl-c1">1</span>,
            deviceId <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>id1<span class="pl-pds">'</span></span>,
            items <span class="pl-k">:</span> [],
        });

        <span class="pl-c">// insert a player</span>
        <span class="pl-k">yield</span> player.saveAsync();

        <span class="pl-c">// find player by id</span>
        <span class="pl-k">var</span> doc <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.findByIdAsync(<span class="pl-s"><span class="pl-pds">'</span>p1<span class="pl-pds">'</span></span>);
        <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>%j<span class="pl-pds">'</span></span>, doc);

        <span class="pl-c">// find player by areaId, return array of players</span>
        <span class="pl-k">var</span> docs <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.findAsync({areaId <span class="pl-k">:</span> <span class="pl-c1">1</span>});
        <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>%j<span class="pl-pds">'</span></span>, docs);

        <span class="pl-c">// find player by deviceType and deviceId</span>
        player <span class="pl-k">=</span> <span class="pl-k">yield</span> Player.findOneAsync({deviceType <span class="pl-k">:</span> <span class="pl-c1">1</span>, deviceId <span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>id1<span class="pl-pds">'</span></span>});

        <span class="pl-c">// update player</span>
        player.areaId <span class="pl-k">=</span> <span class="pl-c1">2</span>;
        <span class="pl-k">yield</span> player.saveAsync();

        <span class="pl-c">// remove the player</span>
        <span class="pl-k">yield</span> player.removeAsync();

    }), <span class="pl-s"><span class="pl-pds">'</span>s1<span class="pl-pds">'</span></span>);
});

<span class="pl-k">if</span> (<span class="pl-c1">require</span>.main <span class="pl-k">===</span> <span class="pl-c1">module</span>) {
    main().finally(<span class="pl-c1">process</span>.exit);
}</pre></div>

<p>To run the sample above:</p>

<ul>
<li>Add the following index config in memdb.conf.js</li>
</ul>

<pre><code>collections : {
    player : {
        indexes : [
            {
                keys : ['areaId'],
            },
            {
                keys : ['deviceType', 'deviceId'],
                unique : true,
            },
        ]
    }
}
</code></pre>

<ul>
<li>restart memdb cluster</li>
</ul>

<pre><code>memdbcluster stop
memdbcluster start
</code></pre>

<ul>
<li>Make sure you have started shard 's1' on localhost:31017</li>
<li>Install npm dependencies</li>
</ul>

<pre><code>npm install memdb-client
</code></pre>

<ul>
<li>Run with node &gt;= 0.12 with --harmony option (or with node &gt;= 0.4.0)</li>
</ul>

<pre><code>node --harmony sample.js
</code></pre>

<p><strong>Check <a href="https://github.com/rain1017/memdb/wiki/API-Reference#mdbgoose">here</a> to see how to port your Mongoose project to Mdbgoose</strong></p>

<h3>
<a id="architecture" class="anchor" href="#architecture" aria-hidden="true"><span class="octicon octicon-link"></span></a>Architecture</h3>

<p><img src="https://github.com/rain1017/memdb/wiki/images/architecture.png" alt="architecture.png"></p>

<h3>
<a id="relationship-between-memdb-and-mongodb" class="anchor" href="#relationship-between-memdb-and-mongodb" aria-hidden="true"><span class="octicon octicon-link"></span></a>Relationship between MemDB and MongoDB</h3>

<p>MemDB is like a 'cache layer' built up on MongoDB which support distributed ACID transaction. </p>

<p>MemDB has its own API which similar to MongoDB, however, you can still use MongoDB's native query API by directly access backend storage, here are the guidelines:</p>

<ul>
<li>Do simple query and update through MemDB API, which is ACID transaction safe.</li>
<li>Do complex query through backend MongoDB, the read is not transaction safe.</li>
<li>Do complex update through backend MongoDB <strong>offline</strong> (All MemDB shards are shutdown).</li>
</ul>

<p>Here are some basic rules for memdb:</p>

<ul>
<li>Data is not bind to specified shard, you can access any data from any shard.</li>
<li>All operations inside a single transaction must be executed on one single shard.</li>
<li>Access the same data from the same shard if possible, which will maximize performance.</li>
</ul>

<h3>
<a id="further-read" class="anchor" href="#further-read" aria-hidden="true"><span class="octicon octicon-link"></span></a>Further read</h3>

<ul>
<li><a href="https://github.com/rain1017/memdb/wiki">The Wiki</a></li>
</ul>

<h3>
<a id="quick-pomelo" class="anchor" href="#quick-pomelo" aria-hidden="true"><span class="octicon octicon-link"></span></a>Quick Pomelo</h3>

<p><a href="https://github.com/rain1017/quick-pomelo">Quick Pomelo</a> is a Scalable, Transactional and Reliable Game Server Framework based on Pomelo and MemDB</p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>Copyright 2015 rain1017.</p>

<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at</p>

<pre><code>http://www.apache.org/licenses/LICENSE-2.0
</code></pre>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
implied. See the License for the specific language governing
permissions and limitations under the License. See the AUTHORS file
for names of contributors.</p>
      </section>
    </div>
    <footer>
      <p>Project maintained by <a href="https://github.com/rain1017">rain1017</a></p>
      <p>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></p>
    </footer>
    <!--[if !IE]><script>fixScale(document);</script><![endif]-->
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-65397800-1");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>
